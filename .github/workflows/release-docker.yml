---
name: release-docker

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      version:
        required: true
        type: string
      arch:
        required: false
        type: string
        default: amd64
      os:
        required: false
        type: string
        default: linux
      docker-image-tag-suffix:
        required: false
        type: string
        default: ""

permissions:
  packages: read

env:
  ARTIFACT_ID: ${{ inputs.ref }}-${{ inputs.os }}-${{ inputs.arch }}
  ARTIFACT_BASENAME: ghcr.io/link-society/flowg/ci-artifacts

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: login-ghcr@docker
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: login-dockerhub@docker
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: publish@docker
        env:
          DOCKERHUB_REPO: linksociety/flowg
          DOCKERHUB_TAG_LATEST: latest${{ inputs.docker-image-tag-suffix }}
          DOCKERHUB_TAG_VERSION: ${{ inputs.version }}${{ inputs.docker-image-tag-suffix }}
        run: |
          docker pull ${ARTIFACT_BASENAME}/docker:${ARTIFACT_ID}
          docker tag ${ARTIFACT_BASENAME}/docker:${ARTIFACT_ID} ${DOCKERHUB_REPO}:${DOCKERHUB_TAG_LATEST}
          docker tag ${ARTIFACT_BASENAME}/docker:${ARTIFACT_ID} ${DOCKERHUB_REPO}:${DOCKERHUB_TAG_VERSION}

          docker push ${DOCKERHUB_REPO}:${DOCKERHUB_TAG_LATEST}
          docker push ${DOCKERHUB_REPO}:${DOCKERHUB_TAG_VERSION}
