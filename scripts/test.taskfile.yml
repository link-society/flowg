version: '3'

tasks:
  unit:
    desc: "Run unit tests"
    cmds:
      - task: "test:unit:go"
      - task: "test:unit:rust:vrl"

  "e2e:api":
    desc: "Run API end-to-end tests"
    dir: ./tests
    cmds:
      - pdm install
      - pdm run pytest
    env:
      FLOWG_TEST_SUITES: api
      FLOWG_TEST_DOCKER_IMAGE_NAME: linksociety/flowg:localdev

  "e2e:web":
    desc: "Run Web end-to-end tests"
    dir: ./tests
    cmds:
      - sudo apt install libasound2t64  # required for Firefox webdriver
      - pdm install
      - pdm run pytest
    env:
      FLOWG_TEST_SUITES: web
      FLOWG_TEST_DOCKER_IMAGE_NAME: linksociety/flowg:localdev

  "e2e:consul":
    desc: "Run Consul end-to-end tests"
    dir: ./tests
    cmds:
      - pdm install
      - pdm run pytest
    env:
      FLOWG_TEST_SUITES: consul
      FLOWG_TEST_DOCKER_IMAGE_NAME: linksociety/flowg:localdev

  bench:
    desc: "Run benchmark"
    dir: ./tests
    cmds:
      - pdm install
      - pdm run pytest
    env:
      FLOWG_TEST_SUITES: bench
      FLOWG_TEST_DOCKER_IMAGE_NAME: linksociety/flowg:localdev

  "test:unit:go":
    internal: true
    cmds:
      - go test -timeout 500ms -v -bench=. ./...

  "test:unit:rust:vrl":
    internal: true
    dir: ./internal/utils/langs/vrl/rust-crate
    cmds:
      - cargo test
